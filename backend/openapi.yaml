openapi: 3.0.0
info:
  title: Easy SKS API
  version: 1.0.0
  description: API for the Easy SKS flashcard study application

servers:
  - url: http://localhost:8000
    description: Local development server

paths:
  /:
    get:
      summary: Root endpoint
      operationId: root
      tags: [General]
      responses:
        "200":
          description: Welcome message
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string

  /health:
    get:
      summary: Health check
      operationId: health_check
      tags: [General]
      responses:
        "200":
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string

  /topics:
    get:
      summary: List available SKS topics
      operationId: list_topics
      tags: [Study]
      responses:
        "200":
          description: List of topics
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Topic"

  /me:
    get:
      summary: Get account summary for current user
      operationId: get_me
      tags: [User]
      responses:
        "200":
          description: Account summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"

  /me/profile:
    patch:
      summary: Update current user's profile fields
      operationId: patch_me_profile
      tags: [User]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProfileUpdateRequest"
      responses:
        "200":
          description: Updated account summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/MeResponse"
        "400":
          description: Invalid profile data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "409":
          description: Mobile number already in use
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /study/due:
    get:
      summary: Get cards due for review
      operationId: get_due_cards
      tags: [Study]
      parameters:
        - name: topic
          in: query
          required: false
          schema:
            type: string
            enum:
              - navigation
              - schifffahrtsrecht
              - wetterkunde
              - seemannschaft_i
              - seemannschaft_ii
      responses:
        "200":
          description: List of due study cards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StudyCardResponse"

  /study/practice:
    get:
      summary: Get cards for practice mode (not limited to due cards)
      operationId: get_practice_cards
      tags: [Study]
      parameters:
        - name: topic
          in: query
          required: false
          schema:
            type: string
            enum:
              - navigation
              - schifffahrtsrecht
              - wetterkunde
              - seemannschaft_i
              - seemannschaft_ii
      responses:
        "200":
          description: List of practice study cards
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/StudyCardResponse"

  /dashboard/summary:
    get:
      summary: Get aggregate dashboard summary for current user
      operationId: get_dashboard_summary
      tags: [Study]
      responses:
        "200":
          description: Dashboard KPI summary
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DashboardSummaryResponse"

  /study/review:
    post:
      summary: Review a card with a rating
      operationId: review_card
      tags: [Study]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ReviewRequest"
      responses:
        "200":
          description: Updated study card after review
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StudyCardResponse"
        "404":
          description: Card or scheduling info not found

  /cards/{card_id}:
    get:
      summary: Get a card by ID
      operationId: get_card
      tags: [Cards]
      parameters:
        - name: card_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: The card
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CardResponse"
        "404":
          description: Card not found

components:
  schemas:
    Topic:
      type: object
      properties:
        value:
          type: string
        label:
          type: string
      required: [value, label]

    MeResponse:
      type: object
      properties:
        user_id:
          type: string
        email:
          type: string
          nullable: true
        full_name:
          type: string
          nullable: true
        mobile_number:
          type: string
          nullable: true
        profile_complete:
          type: boolean
        roles:
          type: array
          items:
            type: string
        plan:
          type: string
        entitlements:
          type: array
          items:
            type: string
        billing_status:
          type: string
          nullable: true
        renews_at:
          type: string
          format: date-time
          nullable: true
        cancels_at:
          type: string
          format: date-time
          nullable: true
      required: [user_id, profile_complete, roles, plan, entitlements]

    ProfileUpdateRequest:
      type: object
      properties:
        full_name:
          type: string
        mobile_number:
          type: string
      required: [full_name, mobile_number]

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
      required: [detail]

    CardContentResponse:
      type: object
      properties:
        text:
          type: string
        images:
          type: array
          items:
            $ref: "#/components/schemas/CardImageResponse"
      required: [text, images]

    CardImageResponse:
      type: object
      properties:
        image_id:
          type: string
        storage_key:
          type: string
        alt_text:
          type: string
          nullable: true
      required: [image_id, storage_key]

    CardResponse:
      type: object
      properties:
        card_id:
          type: string
        front:
          $ref: "#/components/schemas/CardContentResponse"
        answer:
          $ref: "#/components/schemas/CardContentResponse"
        short_answer:
          type: array
          items:
            type: string
        tags:
          type: array
          items:
            type: string
      required: [card_id, front, answer, short_answer, tags]

    SchedulingInfoResponse:
      type: object
      properties:
        state:
          type: string
          enum: [NEW, LEARNING, REVIEW, RELEARNING]
        stability:
          type: number
        difficulty:
          type: number
        reps:
          type: integer
        lapses:
          type: integer
        due:
          type: string
          format: date-time
        last_review:
          type: string
          format: date-time
          nullable: true
      required: [state, stability, difficulty, reps, lapses, due]

    StudyCardResponse:
      type: object
      properties:
        card:
          $ref: "#/components/schemas/CardResponse"
        scheduling_info:
          $ref: "#/components/schemas/SchedulingInfoResponse"
      required: [card, scheduling_info]

    DashboardSummaryResponse:
      type: object
      properties:
        due_now:
          type: integer
        reviewed_today:
          type: integer
        streak_days:
          type: integer
        due_by_topic:
          type: object
          additionalProperties:
            type: integer
        recommended_topic:
          type: string
          nullable: true
        available_cards:
          type: integer
      required:
        - due_now
        - reviewed_today
        - streak_days
        - due_by_topic
        - available_cards

    ReviewRequest:
      type: object
      properties:
        card_id:
          type: string
        rating:
          type: integer
          enum: [1, 2, 3, 4]
          description: "1=Again, 2=Hard, 3=Good, 4=Easy"
      required: [card_id, rating]
